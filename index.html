<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BCCR ¬∑ ¬øCu√°ndo vender mis d√≥lares?</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --bg:    #080b0f;
    --bg2:   #0e1117;
    --bg3:   #141820;
    --line:  rgba(255,255,255,0.07);
    --accent:#4f9cf9;
    --green: #2ecc8a;
    --red:   #f05c5c;
    --yellow:#f0c040;
    --t1:    #f0f4ff;
    --t2:    #8b95a8;
    --t3:    #4a5568;
    --mono:  'IBM Plex Mono', monospace;
    --sans:  'Syne', sans-serif;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    background:var(--bg);color:var(--t1);font-family:var(--sans);min-height:100vh;
    background-image:linear-gradient(rgba(79,156,249,0.025) 1px,transparent 1px),
                     linear-gradient(90deg,rgba(79,156,249,0.025) 1px,transparent 1px);
    background-size:40px 40px;
  }

  /* Header */
  .hdr{border-bottom:1px solid var(--line);padding:14px 24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;background:rgba(8,11,15,0.92);backdrop-filter:blur(8px);position:sticky;top:0;z-index:10}
  .hdr-logo{font-family:var(--mono);font-size:11px;color:var(--accent);letter-spacing:2px}
  .hdr-title{font-size:15px;font-weight:700}
  .dot{width:7px;height:7px;border-radius:50%;background:var(--t3);display:inline-block;margin-right:5px;transition:background .3s}
  .dot.live{background:var(--green);box-shadow:0 0 6px var(--green);animation:pulse 2s infinite}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
  .btn-sm{font-family:var(--mono);font-size:11px;background:transparent;border:1px solid var(--line);border-radius:4px;padding:5px 11px;cursor:pointer;color:var(--t3);text-decoration:none;transition:all .2s}
  .btn-sm:hover{color:var(--t1);border-color:var(--t2)}
  .btn-accent{border-color:var(--accent);color:var(--accent)}
  .btn-accent:hover{background:rgba(79,156,249,0.1);color:var(--accent)}
  .btn-accent.spin{opacity:.5;pointer-events:none}

  /* Container */
  .wrap{max-width:900px;margin:0 auto;padding:24px 16px 60px}

  /* Loading */
  .load-wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:50vh;gap:14px}
  .spinner{width:30px;height:30px;border:2px solid var(--line);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .load-lbl{font-family:var(--mono);font-size:11px;color:var(--t3);letter-spacing:2px}

  /* Error */
  .err{border:1px solid rgba(240,92,92,0.3);background:rgba(240,92,92,0.05);border-radius:8px;padding:20px;margin:16px 0}
  .err strong{color:var(--red)}
  .err p{font-size:13px;color:var(--t2);margin-top:8px;line-height:1.6}
  .err a{color:var(--accent)}

  /* Signal hero */
  .hero{border-radius:12px;padding:24px;margin-bottom:18px;position:relative;overflow:hidden;border:1px solid var(--line)}
  .hero::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at top right,var(--hc,rgba(79,156,249,0.08)) 0%,transparent 70%);pointer-events:none}
  .hero.v  {--hc:rgba(46,204,138,0.13);border-color:rgba(46,204,138,0.3)}
  .hero.vp {--hc:rgba(240,192,64,0.10);border-color:rgba(240,192,64,0.3)}
  .hero.e  {--hc:rgba(240,92,92,0.09); border-color:rgba(240,92,92,0.25)}
  .hero.n  {--hc:rgba(79,156,249,0.08);border-color:rgba(79,156,249,0.18)}
  .hero-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px}
  .hero-ew{font-family:var(--mono);font-size:10px;color:var(--t3);letter-spacing:2px;margin-bottom:6px}
  .hero-badge{font-size:26px;font-weight:800;letter-spacing:-.5px}
  .hero.v  .hero-badge{color:var(--green)}
  .hero.vp .hero-badge{color:var(--yellow)}
  .hero.e  .hero-badge{color:var(--red)}
  .hero.n  .hero-badge{color:var(--accent)}
  .hero-icon{font-size:34px;opacity:.8}
  .hero-detail{font-size:13px;color:var(--t2);line-height:1.7;margin-bottom:18px}
  .hero-metrics{display:flex;gap:0;flex-wrap:wrap;border-top:1px solid var(--line);padding-top:14px}
  .hm{flex:1;min-width:100px;padding:0 16px 0 0}
  .hm-lbl{font-family:var(--mono);font-size:10px;color:var(--t3);margin-bottom:3px;letter-spacing:1px}
  .hm-val{font-family:var(--mono);font-size:17px;font-weight:600}
  .hm-val.g{color:var(--green)}.hm-val.r{color:var(--red)}.hm-val.a{color:var(--accent)}.hm-val.d{color:var(--t3);font-size:13px}

  /* KPI grid */
  .kgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:12px;margin-bottom:18px}
  .kpi{background:var(--bg2);border:1px solid var(--line);border-radius:10px;padding:14px}
  .kpi-lbl{font-family:var(--mono);font-size:10px;color:var(--t3);letter-spacing:1px;margin-bottom:5px}
  .kpi-val{font-family:var(--mono);font-size:20px;font-weight:600;margin-bottom:3px}
  .kpi-val.g{color:var(--green)}.kpi-val.r{color:var(--red)}.kpi-val.a{color:var(--accent)}
  .kpi-sub{font-size:11px;color:var(--t3)}
  .chip{display:inline-block;font-family:var(--mono);font-size:10px;padding:3px 8px;border-radius:20px;margin-top:5px}
  .chip.cg{background:rgba(46,204,138,0.15);color:var(--green)}
  .chip.cr{background:rgba(240,92,92,0.15);color:var(--red)}
  .chip.ca{background:rgba(79,156,249,0.12);color:var(--accent)}
  .chip.cy{background:rgba(240,192,64,0.12);color:var(--yellow)}

  /* Card */
  .card{background:var(--bg2);border:1px solid var(--line);border-radius:10px;padding:20px;margin-bottom:18px}
  .card-ttl{font-size:14px;font-weight:700;margin-bottom:3px}
  .card-sub{font-family:var(--mono);font-size:10px;color:var(--t3);letter-spacing:1px;margin-bottom:14px}

  /* Best bank */
  .best{background:linear-gradient(135deg,rgba(46,204,138,0.08),rgba(46,204,138,0.03));border:1px solid rgba(46,204,138,0.2);border-radius:10px;padding:16px 20px;margin-bottom:18px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
  .best-lbl{font-family:var(--mono);font-size:10px;color:var(--t3);letter-spacing:1px;margin-bottom:2px}
  .best-name{font-size:14px;font-weight:700;color:var(--green)}
  .best-price{font-family:var(--mono);font-size:24px;font-weight:600;color:var(--green)}
  .best-sub{font-size:11px;color:var(--t3)}

  /* Quincena */
  .qcard{background:rgba(79,156,249,0.05);border:1px solid rgba(79,156,249,0.15);border-radius:10px;padding:16px 20px;margin-bottom:18px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
  .q-lbl{font-family:var(--mono);font-size:10px;color:var(--t3);letter-spacing:1px;margin-bottom:2px}
  .q-val{font-family:var(--mono);font-size:24px;font-weight:600;color:var(--accent)}
  .q-advice{font-family:var(--mono);font-size:11px;margin-top:4px}
  .q-advice.v{color:var(--green)}.q-advice.e{color:var(--yellow)}.q-advice.n{color:var(--t3)}

  /* Indicadores */
  .ind-hdr{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:12px}
  .ind-row{display:flex;gap:20px;flex-wrap:wrap;padding-top:12px;border-top:1px solid var(--line)}
  .ind-item .ind-lbl{font-family:var(--mono);font-size:10px;color:var(--t3);margin-bottom:3px}
  .ind-item .ind-val{font-family:var(--mono);font-size:20px;font-weight:600}

  /* Largo plazo */
  .lp-row{display:flex;gap:14px;flex-wrap:wrap;padding-top:12px;border-top:1px solid var(--line)}
  .lp-item .lp-lbl{font-family:var(--mono);font-size:10px;color:var(--t3);margin-bottom:3px}
  .lp-item .lp-val{font-family:var(--mono);font-size:17px;font-weight:600}

  /* Chart */
  .ptabs{display:flex;gap:4px;margin-bottom:12px}
  .ptab{font-family:var(--mono);font-size:11px;background:transparent;color:var(--t3);border:1px solid var(--line);border-radius:4px;padding:4px 10px;cursor:pointer;transition:all .2s}
  .ptab:hover{color:var(--t1)}
  .ptab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .chart-wrap{position:relative;height:220px}

  /* Tabla predicci√≥n */
  .pred-tbl{width:100%;border-collapse:collapse;font-size:13px}
  .pred-tbl th{font-family:var(--mono);font-size:10px;color:var(--t3);text-align:left;padding:8px 10px;border-bottom:1px solid var(--line);letter-spacing:1px}
  .pred-tbl td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,0.03)}
  .pred-tbl tr:hover td{background:rgba(255,255,255,0.02)}
  .pd{font-family:var(--mono);font-size:11px;color:var(--t2)}
  .pv{font-family:var(--mono);font-size:13px;font-weight:600}
  .pv.pu{color:var(--green)}.pv.pd2{color:var(--red)}.pv.pf{color:var(--t2)}
  .dv{font-family:var(--mono);font-size:11px}
  .dv.du{color:var(--green)}.dv.dd{color:var(--red)}.dv.df{color:var(--t3)}
  .mom{font-family:var(--mono);font-size:11px}
  .mom.mp{color:var(--green)}.mom.mn{color:var(--red)}.mom.mz{color:var(--t3)}
  .mbar{height:4px;background:var(--bg3);border-radius:2px;width:56px}
  .mbar-fill{height:4px;background:var(--accent);border-radius:2px}
  .pred-note{font-family:var(--mono);font-size:10px;color:var(--t3);margin-top:10px;line-height:1.7}

  /* Footer */
  .footer{font-family:var(--mono);font-size:10px;color:var(--t3);text-align:center;padding:28px 0 10px;letter-spacing:1px}
  .footer a{color:var(--t3)}

  @media(max-width:500px){
    .hero-badge{font-size:20px}
    .hero-metrics{gap:10px}
    .hm{min-width:80px}
    .kgrid{grid-template-columns:1fr 1fr}
  }
</style>
</head>
<body>

<header class="hdr">
  <div>
    <div class="hdr-logo">BCCR ANALYTICS</div>
    <div class="hdr-title">¬øCu√°ndo vender mis d√≥lares?</div>
  </div>
  <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
    <span style="font-family:var(--mono);font-size:11px;color:var(--t3)">
      <span class="dot" id="dot"></span><span id="statusTxt">Conectando...</span>
    </span>
    <a class="btn-sm" href="https://rmeneses14.github.io/tipoCambioFront">‚Üê Ventanilla</a>
    <button class="btn-sm btn-accent" id="refreshBtn" onclick="doRefresh()">‚Ü∫ Actualizar</button>
  </div>
</header>

<div class="wrap">
  <div id="mc">
    <div class="load-wrap">
      <div class="spinner"></div>
      <div class="load-lbl">CONSULTANDO API ¬∑ BCCR</div>
    </div>
  </div>
</div>

<div class="footer">
  Fuente: <a href="https://gee.bccr.fi.cr" target="_blank">BCCR</a> ¬∑
  API: <a href="https://bccr-hist.onrender.com/docs" target="_blank">bccr-hist.onrender.com</a> ¬∑
  Solo referencial ‚Äî no es asesor√≠a financiera
</div>

<script>
const API = 'https://bccr-hist.onrender.com';
let chart = null, hist = [], analisis = null, lp = null, days = 30;

const fmt  = v => v != null ? '‚Ç°' + Number(v).toLocaleString('es-CR',{minimumFractionDigits:2,maximumFractionDigits:2}) : '‚Äî';
const fmtN = v => v != null ? Number(v).toLocaleString('es-CR',{minimumFractionDigits:2,maximumFractionDigits:2}) : '‚Äî';
const fmtP = v => v != null ? v + '%' : '‚Äî';

function timeout(url, ms) {
  const c = new AbortController();
  const t = setTimeout(() => c.abort(), ms);
  return fetch(url, { signal: c.signal }).finally(() => clearTimeout(t));
}

async function loadAll() {
  document.getElementById('dot').className = 'dot';
  document.getElementById('statusTxt').textContent = 'Consultando...';
  document.getElementById('mc').innerHTML =
    '<div class="load-wrap"><div class="spinner"></div><div class="load-lbl">CONSULTANDO API ¬∑ BCCR</div></div>';

  try {
    // An√°lisis ‚Äî cr√≠tico
    let res;
    try { res = await timeout(API + '/analisis', 60000); }
    catch(e) {
      throw new Error(e.name === 'AbortError'
        ? 'El servidor tard√≥ m√°s de 60s (cold start en Render). Esper√° y reintent√°.'
        : 'Sin conexi√≥n: ' + e.message);
    }
    if (!res.ok) {
      let d = 'HTTP ' + res.status;
      try { const j = await res.json(); d += ': ' + (j.detail || JSON.stringify(j)); } catch(_){}
      throw new Error(d);
    }
    analisis = await res.json();

    // Hist√≥rico ‚Äî no cr√≠tico
    try {
      const rh = await timeout(API + '/historico?dias=30', 30000);
      if (rh.ok) { const j = await rh.json(); hist = j.datos || []; }
    } catch(_){}

    // Largo plazo ‚Äî no cr√≠tico
    try {
      const rl = await timeout(API + '/historico-largo-plazo', 20000);
      if (rl.ok) { lp = await rl.json(); }
    } catch(_){}

    render();
    document.getElementById('dot').className = 'dot live';
    document.getElementById('statusTxt').textContent =
      new Date().toLocaleTimeString('es-CR',{hour:'2-digit',minute:'2-digit'});

  } catch(e) {
    document.getElementById('dot').className = 'dot';
    document.getElementById('statusTxt').textContent = 'Error';
    document.getElementById('mc').innerHTML =
      `<div class="err"><strong>‚ö†Ô∏è No se pudo cargar</strong>
       <p>${e.message}</p>
       <p>API: <a href="${API}/analisis" target="_blank">${API}/analisis</a></p></div>
       <div style="text-align:center;padding:16px">
         <button class="btn-sm btn-accent" onclick="loadAll()">‚Ü∫ Reintentar</button>
       </div>`;
  }
}

function doRefresh() {
  const b = document.getElementById('refreshBtn');
  b.classList.add('spin');
  analisis = null; hist = []; lp = null;
  loadAll().finally(() => b.classList.remove('spin'));
}

function render() {
  const a = analisis;
  if (!a) return;

  // Clase del hero seg√∫n se√±al
  const s = (a.se√±al || '').toUpperCase();
  const hc = s === 'VENDER' ? 'v' : s === 'VENDER PRONTO' ? 'vp' : s === 'ESPERAR' ? 'e' : 'n';
  const hi = s === 'VENDER' ? 'üí∞' : s === 'VENDER PRONTO' ? '‚ö°' : s === 'ESPERAR' ? '‚è≥' : 'üîç';

  // Tendencia del precio de VENTA
  const tend = a.tendencia_7d || 'estable';
  const tendIcon  = tend === 'alza' ? '‚Üë' : tend === 'baja' ? '‚Üì' : '‚Üí';
  const tendChip  = tend === 'alza' ? 'cr' : tend === 'baja' ? 'cg' : 'ca';
  // Para vendedor: baja es BUENO (precio bajando = malo), alza es BUENO (m√°s colones)
  const tendTxt   = tend === 'alza' ? 'PRECIO SUBIENDO ‚úì' : tend === 'baja' ? 'PRECIO BAJANDO ‚úó' : 'ESTABLE';

  // Diferencia venta hoy vs promedio 30d
  const vh = a.precio_venta_hoy, p30v = a.promedio_venta_30d;
  const dv = (vh != null && p30v) ? vh - p30v : null;

  // Quincena
  const hoy  = new Date();
  const proxQ = hoy.getDate() <= 15
    ? new Date(hoy.getFullYear(), hoy.getMonth(), 15)
    : new Date(hoy.getFullYear(), hoy.getMonth()+1, 1);
  const diasQ = Math.ceil((proxQ - hoy) / 86400000);
  const pred  = a.prediccion_15d || [];
  const predQ = pred.find(p => Math.abs(new Date(p.fecha+'T12:00:00') - proxQ) < 3*86400000)
              || pred[pred.length-1];

  // Consejo quincena ‚Äî comparar precio estimado quincena vs precio VENTA hoy
  let qCls = 'n', qTxt = '‚Äî';
  if (predQ && vh) {
    const d = predQ.compra_estimada - vh;
    if (d > 1)       { qCls = 'e'; qTxt = `‚Üë Se estima ${fmtN(d)} m√°s ‚Äî podr√≠a esperar`; }
    else if (d < -1) { qCls = 'v'; qTxt = `‚Üì Se estima ${fmtN(Math.abs(d))} menos ‚Äî mejor vender pronto`; }
    else             { qCls = 'n'; qTxt = '‚Üí Sin diferencia significativa'; }
  }

  // Se√±al de tasas
  const st = a.se√±al_tasas || 'NEUTRAL';
  const stChip = st.includes('FORTALECE') ? 'cr' : st.includes('D√ìLAR') ? 'cg' : 'ca';

  // Filas predicci√≥n
  const rows = pred.map((p, i) => {
    const prev = i === 0 ? (vh || p.compra_estimada) : pred[i-1].compra_estimada;
    const d    = p.compra_estimada - prev;
    // Vendedor: precio sube = bueno = verde
    const vc   = d > 0.5 ? 'pu' : d < -0.5 ? 'pd2' : 'pf';
    const dc   = d > 0.5 ? 'du' : d < -0.5 ? 'dd'  : 'df';
    const ico  = d > 0.5 ? '‚Üë' : d < -0.5 ? '‚Üì' : '‚Üí';
    const lbl  = new Date(p.fecha+'T12:00:00')
                   .toLocaleDateString('es-CR',{weekday:'short',day:'numeric',month:'short'});
    const rMin = a.minimo_compra_90d || 450, rMax = a.maximo_compra_90d || 520;
    const pct  = rMax > rMin ? Math.max(0,Math.min(100,((p.compra_estimada-rMin)/(rMax-rMin))*100)) : 50;
    const isQ  = predQ && p.fecha === predQ.fecha;
    const mom  = p.momentum_diario;
    const mc   = mom >  0.1 ? 'mp' : mom < -0.1 ? 'mn' : 'mz';
    const mt   = mom != null ? (mom >= 0 ? '+' : '') + mom.toFixed(2) : '';
    return `<tr style="${isQ?'background:rgba(79,156,249,0.06)':''}">
      <td><span class="pd">${lbl}${isQ?' <span style="color:var(--accent);font-size:9px">‚óÄ QUINCENA</span>':''}</span></td>
      <td><span class="pv ${vc}">${fmt(p.compra_estimada)}</span></td>
      <td><span class="dv ${dc}">${ico} ${d>=0?'+':''}${fmtN(d)}</span></td>
      <td><span class="mom ${mc}">${mt}</span></td>
      <td><div class="mbar"><div class="mbar-fill" style="width:${pct}%"></div></div></td>
    </tr>`;
  }).join('');

  document.getElementById('mc').innerHTML = `

    <!-- Se√±al principal -->
    <div class="hero ${hc}">
      <div class="hero-top">
        <div>
          <div class="hero-ew">RECOMENDACI√ìN ¬∑ PRECIO DE VENTA USD/CRC</div>
          <div class="hero-badge">${hi} ${a.se√±al || 'NEUTRAL'}</div>
        </div>
        <span class="chip ${tendChip}">${tendIcon} ${tendTxt}</span>
      </div>
      <div class="hero-detail">${a.se√±al_detalle || ''}</div>
      <div class="hero-metrics">
        <div class="hm">
          <div class="hm-lbl">VENTA HOY</div>
          <div class="hm-val ${dv >= 0 ? 'g' : 'r'}">${fmt(vh)}</div>
        </div>
        <div class="hm">
          <div class="hm-lbl">PROM. VENTA 30D</div>
          <div class="hm-val a">${fmt(p30v)}</div>
        </div>
        <div class="hm">
          <div class="hm-lbl">DIFERENCIA</div>
          <div class="hm-val ${dv >= 0 ? 'g' : 'r'}">${dv != null ? (dv>=0?'+':'') + fmtN(dv) : '‚Äî'}</div>
        </div>
        <div class="hm">
          <div class="hm-lbl">COMPRA (REF)</div>
          <div class="hm-val d">${fmt(a.precio_compra_hoy)}</div>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kgrid">
      <div class="kpi">
        <div class="kpi-lbl">M√ÅXIMO VENTA 30D</div>
        <div class="kpi-val g">${fmt(a.maximo_compra_90d)}</div>
        <div class="kpi-sub">El mejor precio reciente</div>
        <span class="chip cg">‚Üë Mejor</span>
      </div>
      <div class="kpi">
        <div class="kpi-lbl">M√çNIMO VENTA 30D</div>
        <div class="kpi-val r">${fmt(a.minimo_compra_90d)}</div>
        <div class="kpi-sub">El peor precio reciente</div>
        <span class="chip cr">‚Üì Peor</span>
      </div>
      <div class="kpi">
        <div class="kpi-lbl">PROM. COMPRA 30D</div>
        <div class="kpi-val" style="color:var(--t2)">${fmt(a.promedio_compra_30d)}</div>
        <div class="kpi-sub">Lo que pagan los bancos</div>
      </div>
      <div class="kpi">
        <div class="kpi-lbl">D√çAS A QUINCENA</div>
        <div class="kpi-val ${diasQ <= 3 ? 'r' : 'a'}">${diasQ}d</div>
        <div class="kpi-sub">${proxQ.toLocaleDateString('es-CR',{day:'numeric',month:'long'})}</div>
      </div>
    </div>

    <!-- Mejor entidad -->
    <div class="best">
      <div>
        <div class="best-lbl">MEJOR PRECIO DE VENTA HOY (VENTANILLA)</div>
        <div class="best-name">${a.mejor_entidad_compra || '‚Äî'}</div>
      </div>
      <div style="text-align:right">
        <div class="best-price">${fmt(a.mejor_precio_compra)}</div>
        <div class="best-sub">por d√≥lar vendido</div>
      </div>
    </div>

    <!-- Quincena -->
    <div class="qcard">
      <div>
        <div class="q-lbl">PR√ìXIMA QUINCENA</div>
        <div style="font-size:13px;color:var(--t2)">${proxQ.toLocaleDateString('es-CR',{day:'numeric',month:'long',year:'numeric'})}</div>
        <div class="q-advice ${qCls}">${qTxt}</div>
      </div>
      <div style="text-align:right">
        <div class="q-lbl">D√çAS RESTANTES</div>
        <div class="q-val">${diasQ}</div>
        ${predQ ? `<div style="font-family:var(--mono);font-size:11px;color:var(--t3)">Est. ${fmt(predQ.compra_estimada)}</div>` : ''}
      </div>
    </div>

    <!-- Indicadores monetarios -->
    <div class="card">
      <div class="ind-hdr">
        <div>
          <div class="card-ttl">Indicadores Monetarios BCCR</div>
          <div class="card-sub">TBP ALTA = COL√ìN SE FORTALECE = PRECIO DE VENTA BAJA</div>
        </div>
        <span class="chip ${stChip}">${st}</span>
      </div>
      ${a.se√±al_tasas_detalle ? `<div style="font-size:13px;color:var(--t2);line-height:1.7;margin-bottom:10px">${a.se√±al_tasas_detalle}</div>` : ''}
      <div class="ind-row">
        <div class="ind-item"><div class="ind-lbl">TASA B√ÅSICA PASIVA</div><div class="ind-val" style="color:var(--accent)">${fmtP(a.tasa_basica_pasiva)}</div></div>
        <div class="ind-item"><div class="ind-lbl">TPM</div><div class="ind-val">${fmtP(a.tpm)}</div></div>
        <div class="ind-item"><div class="ind-lbl">FPC</div><div class="ind-val" style="color:var(--green)">${fmtP(a.fpc)}</div></div>
        <div class="ind-item"><div class="ind-lbl">FPD</div><div class="ind-val" style="color:var(--red)">${fmtP(a.fpd)}</div></div>
      </div>
    </div>

    <!-- Largo plazo -->
    ${lp ? `
    <div class="card">
      <div class="card-ttl">Referencia Hist√≥rica MONEX</div>
      <div class="card-sub">CONTEXTO DE LARGO PLAZO ‚Äî BANCO CENTRAL CR</div>
      <div class="lp-row">
        <div class="lp-item"><div class="lp-lbl">PROM. ${new Date().getFullYear()}</div><div class="lp-val" style="color:var(--accent)">${fmt(lp.promedio_monex_anio_actual)}</div></div>
        <div class="lp-item"><div class="lp-lbl">PROM. ${new Date().getFullYear()-1}</div><div class="lp-val">${fmt(lp.promedio_monex_anio_anterior)}</div></div>
        <div class="lp-item"><div class="lp-lbl">PROM. HIST√ìRICO</div><div class="lp-val" style="color:var(--yellow)">${fmt(lp.promedio_monex_historico)}</div></div>
        <div class="lp-item"><div class="lp-lbl">M√çNIMO HIST.</div><div class="lp-val" style="color:var(--green)">${fmt(lp.minimo_monex_historico)}</div></div>
        <div class="lp-item"><div class="lp-lbl">M√ÅXIMO HIST.</div><div class="lp-val" style="color:var(--red)">${fmt(lp.maximo_monex_historico)}</div></div>
      </div>
    </div>` : ''}

    <!-- Gr√°fico -->
    <div class="card">
      <div class="card-ttl">Precio de Venta USD/CRC</div>
      <div class="card-sub" style="margin-bottom:10px">LO QUE RECIB√çS POR CADA D√ìLAR ¬∑ EMA-7 ¬∑ EMA-14 ¬∑ PREDICCI√ìN</div>
      <div class="ptabs" id="ptabs">
        <button class="ptab" data-d="7">7D</button>
        <button class="ptab" data-d="15">15D</button>
        <button class="ptab active" data-d="30">30D</button>
      </div>
      <div class="chart-wrap"><canvas id="chart"></canvas></div>
    </div>

    <!-- Predicci√≥n -->
    <div class="card">
      <div class="card-ttl">¬øCu√°ndo vender? ‚Äî Proyecci√≥n 15 d√≠as h√°biles</div>
      <div class="card-sub">EMA + MOMENTUM + PATR√ìN SEMANAL + SE√ëAL TASAS ¬∑ SOLO REFERENCIAL</div>
      <div style="overflow-x:auto">
        <table class="pred-tbl">
          <thead><tr>
            <th>FECHA</th>
            <th>VENTA EST.</th>
            <th>VARIACI√ìN</th>
            <th>MOMENTUM</th>
            <th>NIVEL 30D</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
      <div class="pred-note">
        MOMENTUM: positivo (+) ‚Üí precio sube ‚Üí m√°s colones para vos ‚úì ¬∑ negativo (‚àí) ‚Üí precio baja ‚Üí menos colones ‚úó<br>
        NIVEL 30D: barra muestra posici√≥n del precio estimado dentro del rango m√≠n/m√°x de los √∫ltimos 30 d√≠as
      </div>
    </div>
  `;

  // Inicializar chart
  setTimeout(() => renderChart(days), 50);

  // Tabs
  document.querySelectorAll('.ptab').forEach(t => {
    t.addEventListener('click', () => {
      document.querySelectorAll('.ptab').forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      days = parseInt(t.dataset.d);
      renderChart(days);
    });
  });
}

// ‚îÄ‚îÄ Chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function ema(arr, k) {
  const a = 2 / (k+1); let p = null;
  return arr.map(v => {
    if (v == null) return null;
    if (p === null) { p = v; return Math.round(v*100)/100; }
    p = v*a + p*(1-a); return Math.round(p*100)/100;
  });
}

function renderChart(d) {
  const a = analisis; if (!a) return;
  const cv = document.getElementById('chart'); if (!cv) return;

  const h   = hist.slice(-d);
  const pr  = a.prediccion_15d || [];
  const hl  = h.map(x => new Date(x.fecha+'T12:00:00').toLocaleDateString('es-CR',{day:'numeric',month:'short'}));
  const pl  = pr.map(x => new Date(x.fecha+'T12:00:00').toLocaleDateString('es-CR',{day:'numeric',month:'short'}));
  const all = [...hl, ...pl];
  const nl  = pl.length;

  const vData  = [...h.map(x=>x.venta),  ...new Array(nl).fill(null)];
  const cData  = [...h.map(x=>x.compra), ...new Array(nl).fill(null)];
  const pData  = [...new Array(hl.length).fill(null), ...pr.map(x=>x.compra_estimada)];
  const e7     = [...ema(h.map(x=>x.venta), 7),  ...new Array(nl).fill(null)];
  const e14    = [...ema(h.map(x=>x.venta), 14), ...new Array(nl).fill(null)];
  const promL  = all.map(() => a.promedio_venta_30d);
  const histL  = lp?.promedio_monex_historico ? all.map(() => lp.promedio_monex_historico) : null;

  if (chart) { chart.destroy(); chart = null; }
  const ctx = cv.getContext('2d');
  const grad = ctx.createLinearGradient(0,0,0,220);
  grad.addColorStop(0,'rgba(46,204,138,0.14)');
  grad.addColorStop(1,'rgba(46,204,138,0)');

  chart = new Chart(ctx, {
    type: 'line',
    data: { labels: all, datasets: [
      { label:'Venta üí∞', data:vData, borderColor:'#2ecc8a', backgroundColor:grad, borderWidth:2.5, fill:true, tension:.35, pointRadius:0, pointHoverRadius:5 },
      { label:'Compra (ref)', data:cData, borderColor:'rgba(240,92,92,0.35)', backgroundColor:'transparent', borderWidth:1, fill:false, tension:.35, pointRadius:0 },
      { label:'Predicci√≥n', data:pData, borderColor:'rgba(79,156,249,0.8)', backgroundColor:'rgba(79,156,249,0.05)', borderWidth:1.5, borderDash:[4,3], fill:true, tension:.3, pointRadius:0, pointHoverRadius:4 },
      { label:'Prom. venta 30d', data:promL, borderColor:'rgba(240,192,64,0.45)', backgroundColor:'transparent', borderWidth:1, borderDash:[3,4], fill:false, tension:0, pointRadius:0 },
      { label:'EMA-7', data:e7,  borderColor:'rgba(160,100,255,0.55)', backgroundColor:'transparent', borderWidth:1.5, borderDash:[2,3], fill:false, tension:.3, pointRadius:0 },
      { label:'EMA-14', data:e14, borderColor:'rgba(255,160,50,0.45)', backgroundColor:'transparent', borderWidth:1.5, borderDash:[2,3], fill:false, tension:.3, pointRadius:0 },
      ...(histL ? [{ label:'Prom. hist√≥rico MONEX', data:histL, borderColor:'rgba(255,255,255,0.12)', backgroundColor:'transparent', borderWidth:1, borderDash:[6,4], fill:false, tension:0, pointRadius:0 }] : [])
    ]},
    options: {
      responsive:true, maintainAspectRatio:false,
      interaction:{ intersect:false, mode:'index' },
      plugins: {
        legend:{ labels:{ color:'#4a5568', font:{ family:"'IBM Plex Mono'", size:10 }, boxWidth:12, padding:10 }},
        tooltip:{ backgroundColor:'#0e1117', borderColor:'rgba(255,255,255,0.08)', borderWidth:1, titleColor:'#f0f4ff', bodyColor:'#8b95a8', titleFont:{ family:"'IBM Plex Mono'", size:11 }, bodyFont:{ family:"'IBM Plex Mono'", size:11 },
          callbacks:{ label: c => c.parsed.y == null ? null : ` ${c.dataset.label}: ‚Ç°${c.parsed.y.toLocaleString('es-CR',{minimumFractionDigits:2})}` }
        }
      },
      scales:{
        x:{ ticks:{ color:'#4a5568', font:{family:"'IBM Plex Mono'",size:9}, maxRotation:0, maxTicksLimit:8 }, grid:{ color:'rgba(255,255,255,0.03)' }},
        y:{ ticks:{ color:'#4a5568', font:{family:"'IBM Plex Mono'",size:9}, callback: v => '‚Ç°' + v.toLocaleString('es-CR') }, grid:{ color:'rgba(255,255,255,0.04)' }}
      }
    }
  });
}

loadAll();
</script>
</body>
</html>
